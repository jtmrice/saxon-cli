#!/usr/bin/env bash

# Copyright 2014 Georgia Tech Research Corporation (GTRC). All rights reserved.

# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.

# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.

# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

cd "$(dirname "$0")"

. ./configure-helper.bash

config_decl_set_package_name saxon-cli

OPTIND=1
while getopts :hp:-: option
do case "$option" in
       h ) opt_help;;
       p ) opt_prefix "$OPTARG";;
       - ) case "$OPTARG" in
               help ) opt_help;;
               prefix=* ) opt_prefix "${OPTARG#*=}";;
               help=* )
                   fail "No argument expected for long option \"${OPTARG%%=*}\"\n";;
               prefix ) fail "Argument expected for long option \"$OPTARG\"\n";;
               * ) fail "Unknown long option \"$OPTARG\"\n";;
           esac;;
       '?' ) fail "Unknown short option \"$OPTARG\"\n";;
       : ) fail "Short option \"$OPTARG\" missing argument";;
       * ) fail "Bad state in getopts (OPTARG=\"$OPTARG\")\n";;
   esac
done
shift $((OPTIND-1))

[[ is-set = ${config_prefix:+is-set} ]] || fail "option --prefix is required"
config_set_shared

config_decl_set_command CONFIG_BASH_COMMAND bash
config_decl_set_command CONFIG_CHMOD_COMMAND gchmod chmod
config_decl_set_command CONFIG_CP_COMMAND gcp cp
config_decl_set_command CONFIG_FIND_COMMAND gfind find
config_decl_set_command CONFIG_GRADLE_COMMAND "${GRADLE_HOME-unset}"/bin/gradle gradle
config_decl_set_command CONFIG_GREP_COMMAND grep
config_decl_set_command CONFIG_JAVA_COMMAND "${JAVA_HOME:+$JAVA_HOME/bin/java}" java
config_decl_set_command CONFIG_M4_COMMAND gm4 m4
config_decl_set_command CONFIG_MKDIR_COMMAND gmkdir mkdir
config_decl_set_command CONFIG_RM_COMMAND grm rm
config_decl_set_command CONFIG_RSYNC_COMMAND rsync
config_decl_set_command CONFIG_STOW_COMMAND stow
config_decl_set_command CONFIG_JOIN_STRINGS_COMMAND join-strings

config_decl_set_file CONFIG_COMMON_BASH "$config_prefix"/lib/bash/common.bash
config_decl_set_file CONFIG_OPT_HELP_BASH "$config_prefix"/lib/bash/opt_help.bash
config_decl_set_file CONFIG_OPT_VERBOSE_BASH "$config_prefix"/lib/bash/opt_verbose.bash
config_decl_set_file CONFIG_FAIL_BASH "$config_prefix"/lib/bash/fail.bash

generated=(Makefile build.gradle)

config_decl_set CONFIG_PRODUCTS "$config_decls_m4 reconfigure ${generated[*]}"

# reconfigure
cat <<EOF > reconfigure
exec ./configure --prefix="$config_prefix"
EOF
chmod 755 ./reconfigure

for file in "${generated[@]}"
do
    rm -f "$file"
    [[ -f "$file".in ]] || fail "$file.in does not exist"
    m4 -P "$config_decls_m4" "$file".in > "$file"
    ! grep 'CONFIG_' "$file" || fail "$file.in used bad macro"
    chmod uog-w "$file"
done

# Local Variables:
# mode: shell-script
# eval: (sh-set-shell "bash")
# indent-tabs-mode: nil
# fill-column: 9999
# End:
