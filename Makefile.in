
SHELL = @bash@

PACKAGE_NAME = @PACKAGE_NAME@
prefix = @prefix@
datarootdir = @datarootdir@
datadir = @datadir@
exec_prefix = @exec_prefix@
bindir = @bindir@

INSTALL = @INSTALL@
MKDIR_P = @MKDIR_P@
SED = @SED@

gradle = @gradle@
java = @java@
m4 = @m4@
tokenize_strings = @tokenize_strings@

CONFIG_COMMON_BASH = @CONFIG_COMMON_BASH@
CONFIG_OPT_HELP_BASH = @CONFIG_OPT_HELP_BASH@
CONFIG_OPT_VERBOSE_BASH = @CONFIG_OPT_VERBOSE_BASH@
CONFIG_FAIL_BASH = @CONFIG_FAIL_BASH@
CONFIG_TEMP_BASH = @CONFIG_TEMP_BASH@

package_share_dir = $(datadir)/$(PACKAGE_NAME)


SRC_BIN_FILES = $(wildcard src/bin/*)

OUT_SHARE_FILES = $(wildcard out/share/*)
OUT_BIN_FILES = $(patsubst src/bin/%,out/bin/%,$(SRC_BIN_FILES))

INSTALL_SHARE_FILES = $(patsubst out/share/%,$(package_share_dir)/%,$(OUT_SHARE_FILES))
INSTALL_BIN_FILES = $(patsubst out/bin/%,$(bindir)/%,$(OUT_BIN_FILES))
INSTALL_FILES = $(INSTALL_SHARE_FILES) $(INSTALL_BIN_FILES)

BUILT_GRADLE_OUT_TOKEN = out/built-gradle

.PHONY: default
default: build

.PHONY: build
build: $(OUT_BIN_FILES)
	$(gradle) out

out/bin/%: src/bin/% src/macros.m4
	$(MKDIR_P) $(dir $@)
	$(m4)  --prefix-builtins \
		-DCONFIG_PACKAGE_SHARE_DIR=$(package_share_dir) \
		-DCONFIG_BIN_DIR=$(bindir) \
		-DCONFIG_COMMON_BASH=$(CONFIG_COMMON_BASH) \
		-DCONFIG_OPT_HELP_BASH=$(CONFIG_OPT_HELP_BASH) \
		-DCONFIG_OPT_VERBOSE_BASH=$(CONFIG_OPT_VERBOSE_BASH) \
		-DCONFIG_FAIL_BASH=$(CONFIG_FAIL_BASH) \
		-DCONFIG_TEMP_BASH=$(CONFIG_TEMP_BASH) \
		-DCONFIG_TOKENIZE_STRINGS_COMMAND=$(tokenize_strings) \
		-DCONFIG_JAVA_COMMAND=$(java) \
		src/macros.m4 $< \
		> $@

.PHONY: install
install: $(INSTALL_FILES)

$(package_share_dir)/%: out/share/%
	$(RM) -f $@
	$(MKDIR_P) $(dir $@)
	$(INSTALL) --mode=644 $< $(dir $@)

$(bindir)/%: out/bin/%
	$(RM) -f $@
	$(MKDIR_P) $(dir $@)
	$(INSTALL) --mode=755 $< $(dir $@)

.PHONY: clean
clean:
	$(RM) -r out

