# Copyright 2014 Georgia Tech Research Corporation (GTRC). All rights reserved.

# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.

# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.

# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.

SHELL = CONFIG_BASH_COMMAND

image_dir = tmp/image
image_share_dir = $(image_dir)/share/CONFIG_PACKAGE_NAME

src_dir = src
src_files = $(shell CONFIG_FIND_COMMAND $(src_dir) -type f ! -name '*~' -print)

image_files = $(patsubst $(src_dir)/%,$(image_dir)/%,$(src_files))

.PHONY: build before-build clean distclean install uninstall

build: before-build $(image_files)
	CONFIG_GRADLE_COMMAND out
	CONFIG_FIND_COMMAND $(image_dir) -type f -print0 | xargs -0 chmod uog-w

before-build:
	CONFIG_RM_COMMAND -rf $(image_dir)

$(image_dir)/%: CONFIG_DECLS_M4 $(src_dir)/%
	CONFIG_MKDIR_COMMAND -p $(dir $@)
	CONFIG_RM_COMMAND -f $@
	CONFIG_M4_COMMAND -P $^ > $@
	CONFIG_CHMOD_COMMAND --reference=$(src_dir)/$* $@
	CONFIG_CHMOD_COMMAND uog-w $@

clean:
	CONFIG_RM_COMMAND -rf tmp
	CONFIG_FIND_COMMAND . -type f -name '*~' -delete

distclean: clean
	CONFIG_RM_COMMAND -rf .gradle
	CONFIG_RM_COMMAND -f CONFIG_PRODUCTS

uninstall:
	- 'CONFIG_STOW_COMMAND' -d 'CONFIG_STOW_PACKAGES_DIR' -t 'CONFIG_PREFIX' --delete --verbose --no-folding 'CONFIG_PACKAGE_NAME'
	CONFIG_RM_COMMAND -rf 'CONFIG_STOW_PACKAGE_DIR'

install: uninstall build
	'CONFIG_RSYNC_COMMAND' --archive --delete $(image_dir)/ 'CONFIG_STOW_PACKAGE_DIR/'
	'CONFIG_STOW_COMMAND' -d 'CONFIG_STOW_PACKAGES_DIR' -t 'CONFIG_PREFIX' --stow --verbose --no-folding 'CONFIG_PACKAGE_NAME'
